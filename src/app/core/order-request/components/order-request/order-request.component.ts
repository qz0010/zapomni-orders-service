import {AfterContentChecked, Component, OnInit} from '@angular/core';
import {Observable, throwError} from 'rxjs';
import {HttpResponse} from '@angular/common/http';
import {OrdersService} from '../../../../shared/services/orders.service';
import {catchError, finalize, switchMap} from 'rxjs/operators';
import {IOrder} from '../../../../shared/types/api';

@Component({
  selector: 'app-order-request',
  templateUrl: './order-request.component.html',
  styleUrls: ['./order-request.component.styl']
})
export class OrderRequestComponent implements OnInit, AfterContentChecked {
  public ordersError = false;
  public orders: any[];
  // public orders: any[] = [{"data":{"uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","created_at":"2020-10-12T08:12:14.163Z","updated_at":"2020-10-16T15:38:05.802Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"6066068","showcase_uuid":"ec91c06b-18ee-4209-826a-a15aefbc8769","account_uuid":"6fb5ad46-9373-4646-8b2c-4b3cb41123b0","meta":{"lang":"ru","locale":"ru"},"account_session_uuid":"d3528723-04f1-4c56-a48b-9f6c9a2ce7d5","status":"done","has_refunds":false,"has_reserves":false,"nominal_cost":"55000","total_cost":"55000","total_count":1,"messages":["0038ee90-a22b-4b8c-8d4e-0c9599cd9223","0038ee90-a227-4f6e-9189-b23571e2534d"],"email":"qz0010@mail.ru","phone":"+79789219532","promo_gift_uuid":null,"Showcase":{"uuid":"ec91c06b-18ee-4209-826a-a15aefbc8769","created_at":"2018-12-07T10:39:48.132Z","updated_at":"2020-10-08T09:59:51.071Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"en":"Moscow planetarium","ru":"Московский планетарий"},"hostname":"planetarium-widget.lastick.xd.unitix.cloud","comment":"prod planet","widget_settings":{"limits":{"tickets_in_order":16},"routes":{"index":"/events"},"calendar":{"length":7,"expanded":true},"own_event":true,"show_spot":true,"defaultLang":"en","enablePromocodes":true,"events_hide_time":true,"additionalLanguages":[{"val":"hy","name":"ARM"}]},"app_settings":{"limits":{"tickets_in_order":6}},"allowed_payment_methods":["76f7dd45-62fa-444c-a5a3-a6780413ec7c","c82e3cff-f792-4493-afba-b7df760db425"],"notifications":{"sms":"lastick_order","email":"lastick_order_planetarium","unsold":{"email":"lastick_unsold"},"sms_activation":"lastick_sms_activation"},"source_uuids":["0d887ab4-7016-4fa5-aa7d-0f36b8213fb1","8bc8d574-c54b-4ae7-b0c4-a14085a4027b"],"source_publication_uuids":["c77ffb4d-2c50-4822-850e-e65ffc2f1ce9"],"spot_uuids":null,"event_uuids":null,"schedule_uuids":null,"tag_uuids":["0418e4ff-c522-4ced-a3da-88ba04867495"],"restrictions":{"tag_uuids":["7ff0696d-2332-4bb0-ae94-7d7a10b9661f","0321303b-f855-4576-8a0c-d4d53fd5f6e0","7c866a5b-2deb-4704-a38e-0eb96424c681","db992968-4508-4ca0-8149-89740c18f427","aee05056-270b-4d89-bf7c-56ae62719248","3d5bf8db-653c-4043-905b-5fd8b28af9b0"]},"payment_settings":{"order_status_redirect":"https://planetarium-widget.lastick.xd.unitix.cloud/result/{:uuid}/ru"},"price_modifier_uuid":null,"settings":{}},"User":null,"ExtOrdersContainer":[{"data":{"uuid":"c5d3b19c-000b-4359-bd3d-a17453e17a14","created_at":"2020-10-12T08:11:52.547Z","updated_at":"2020-10-12T08:12:39.660Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"19595728","has_payments":false,"has_refunds":false,"has_reserves":true,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","meta":{"status":"complete","order_uuid":"a2cb3c04-0c62-11eb-9565-4237f251a997","payment_sum":20000,"payment_uuid":"b1cfe808-0c62-11eb-9565-4237f251a997","reservation_exp":"2020-10-12 11:27:14+03","ext_schedule_uuid":"69e7dd62-f3f1-4eeb-a417-6a5e094ead24"},"ttl":"2020-10-12T08:26:52.546Z","OrderItemsContainer":[{"data":{"uuid":"7797f1c7-3400-40a5-806f-dc3c8b98a423","created_at":"2020-10-12T08:11:52.481Z","updated_at":"2020-10-16T15:12:19.668Z","is_active":true,"deleted_at":null,"is_deleted":false,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","cart_item_uuid":null,"number":"43002078","meta":{"item_id":9781,"place_id":"8","price_id":"0","ticket_id":44712,"position_id":42847,"ticket_number":"128312847"},"product_item_uuid":"34119b0b-8d5d-49f8-9543-f77f9c04bb41","price_value_uuid":"04663f14-c459-431e-9fec-a47b24b14208","currency":"rur","nominal_price":"20000","price_modifiers":[],"price_formula":null,"price":"20000","service_fee":"0","total_sum":"20000","refund_fee":"0","barcode":{"value":"00004096890409643973","format":"qrcode"},"status":"refund","status_ttl":null,"ext_price_value_uuid":"fde9e553-9e42-41e0-8ad8-d3603a5d778b","ext_nominal_price":"20000","ext_order_uuid":"c5d3b19c-000b-4359-bd3d-a17453e17a14","last_error":null,"applied_promocodes":[],"applied_promos":[],"ProductItem":{"product_item_type":"ticket","uuid":"34119b0b-8d5d-49f8-9543-f77f9c04bb41","created_at":"2020-10-12T07:56:00.848Z","updated_at":"2020-10-12T07:56:00.848Z","is_active":true,"deleted_at":null,"is_deleted":false,"source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","product_desc_uuid":"d3d14343-8957-403a-9032-06e576788247","supplier_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","quantity":1,"price_category_uuid":"fab026cc-55c7-4ff9-a71e-d24b671f55c1","ext_hall_uuid":"2a633635-7aa2-42b5-a8ed-1b0c1a0ad715","ext_spot_uuid":"d6fce4dd-39a1-4e99-ac21-aeb53b986ff6","ext_schedule_uuid":"69e7dd62-f3f1-4eeb-a417-6a5e094ead24","ext_price_values":["fde9e553-9e42-41e0-8ad8-d3603a5d778b"],"ext_place_uuid":"09880c92-3366-45b4-9bdc-ef2b53848215","place_uuid":"0b71c5b9-0f3c-4efb-b0fc-269303b16de2","schedule_uuid":"dd74e2ea-0735-4781-8bef-49c8ea08cbf3","hall_uuid":"a92dc826-9321-4137-9ded-ac3a8bf1c38b","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","meta":{"ext_row_num":"2","ext_place_id":8,"ext_seat_num":"6","ext_sector_id":1,"ext_fragment_id":0},"is_for_sale":true,"is_for_booking":false,"group_sale":false,"ProductDesc":{"product_type":"event","uuid":"d3d14343-8957-403a-9032-06e576788247","created_at":"2018-12-14T14:08:52.140Z","updated_at":"2019-03-12T02:01:39.396Z","is_active":true,"deleted_at":null,"is_deleted":false,"product_category_uuid":null,"tags":null,"name":{"en":null,"ru":"Город Солнца"},"appname":{},"short_name":{"en":null,"ru":"Город Солнца"},"description":{},"short_description":{},"extended_props":{},"poster":null,"posters":null,"media":null,"rating":null,"pg_rating":"6+","tabs":null,"do_not_update_from_ext":true,"content_loaded_at":null,"content_approved_at":null,"duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":15,"seconds":0,"milliseconds":0},"is_season":false,"season_label":null,"season_number":null},"Schedule":{"uuid":"dd74e2ea-0735-4781-8bef-49c8ea08cbf3","created_at":"2020-10-12T07:51:45.827Z","updated_at":"2020-10-12T07:51:45.882Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_uuid":"a92dc826-9321-4137-9ded-ac3a8bf1c38b","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","event_uuid":"d3d14343-8957-403a-9032-06e576788247","has_geometry":true,"is_for_sale":true,"season_event_uuid":null,"is_season_head":false,"is_season_part":false,"season_schedules":null,"begin_time":"2020-10-24T09:15:00.000Z","end_time":"2020-10-24T09:30:00.000Z","duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":15,"seconds":0,"milliseconds":0},"begin":"2020-10-24 12:15:00","end":"2020-10-24 12:30:00","hall_geometry_uuid":"0ff0a0ba-ee68-40e3-be0c-64736e0bfd49","tags":["92ea376d-8c39-4057-9065-c48663af91fe","9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","7c866a5b-2deb-4704-a38e-0eb96424c681"],"price_modifier_uuid":null,"organizer_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","is_sold_out":false,"LinkedSchedules":[]},"HallPlace":{"uuid":"0b71c5b9-0f3c-4efb-b0fc-269303b16de2","created_at":"2020-07-24T18:54:08.732Z","updated_at":"2020-07-24T18:54:08.732Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_geometry_uuid":"0ff0a0ba-ee68-40e3-be0c-64736e0bfd49","hall_uuid":"a92dc826-9321-4137-9ded-ac3a8bf1c38b","sector_uuid":null,"fragment_uuid":"c0a3d7a9-904f-41b9-a7a7-6e6ec53e512d","row_uuid":"c15afc73-660c-4708-8b13-2f3453656c5d","name":"6","geometry":{"h":518.5185185185193,"w":518.5185185185193,"cx":3481.481481481481,"cy":518.5185185185193},"symbol_uuid":null,"meta":{"row":{"name":"2","uuid":"c15afc73-660c-4708-8b13-2f3453656c5d","prefix":null},"seat":"6","group":null,"sector":null,"fragment":{"name":{"ru":null},"uuid":"c0a3d7a9-904f-41b9-a7a7-6e6ec53e512d"},"group_size":null}},"Hall":{"uuid":"a92dc826-9321-4137-9ded-ac3a8bf1c38b","created_at":"2018-12-07T09:45:02.418Z","updated_at":"2019-02-27T10:54:26.045Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"en":"Small starry hall","ru":"Малый звёздный зал"},"short_name":{"ru":"Малый звёздный зал"},"description":null,"address":{"ru":null},"location":null,"poster":null,"media_info":[{"name":"smallhall.jpg","path":"/b8/3c/a92dc826-9321-4137-9ded-ac3a8bf1c38b/smallhall.jpg","size":865817,"type":"image/jpeg","color":[8,13,32],"width":1280,"height":347,"palette":[[10,16,34],[21,90,172],[173,177,174],[66,168,220]],"uploaded_at":1545125364682}],"contacts":null,"work_hours":null,"website":null,"spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","tags":["7c866a5b-2deb-4704-a38e-0eb96424c681"],"tabs":null},"Spot":{"uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","created_at":"2018-12-07T09:45:02.123Z","updated_at":"2020-10-14T13:34:53.692Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"ru":"Планетарий"},"short_name":{"ru":"Планетарий"},"description":null,"address":{"ru":"укукуккуцукуук"},"location":null,"poster":null,"media_info":[{"name":"pony.png","path":"/27/60/2e8797e6-39c2-48b5-857a-ef4331060672/pony.png","size":700433,"type":"image/png","color":[4,4,4],"width":1920,"height":1200,"palette":[[5,4,5],[227,175,161],[108,69,140],[14,173,115]],"uploaded_at":1560160798607}],"contacts":null,"work_hours":{"date":{},"day_of_week":{"0":{"n":0,"end_time":"14:00","start_time":"10:00"},"1":{"n":1,"end_time":"18:00","start_time":"10:00"},"2":{"n":2,"end_time":"18:00","start_time":"10:00"},"3":{"n":3,"end_time":"18:00","start_time":"10:00"},"4":{"n":4,"end_time":"16:00","start_time":"10:00"},"5":{"n":5,"end_time":"18:00","start_time":"10:00"},"6":{"n":6,"end_time":"15:00","start_time":"10:00"}},"day_of_year":{}},"website":null,"tags":["9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","92ea376d-8c39-4057-9065-c48663af91fe"],"tabs":null,"city_uuid":"1de91a10-069b-441e-91ca-3aeefcbfd0a1"},"SeasonEvent":null},"PriceValue":{"uuid":"04663f14-c459-431e-9fec-a47b24b14208","created_at":"2020-10-12T07:56:00.737Z","updated_at":"2020-10-12T07:56:00.737Z","is_active":true,"is_base_price":true,"price_category_uuid":"fab026cc-55c7-4ff9-a71e-d24b671f55c1","schedule_uuid":"dd74e2ea-0735-4781-8bef-49c8ea08cbf3","amount":20000,"amount_currency":"rur","base_group_price":null,"PriceCategory":{"uuid":"fab026cc-55c7-4ff9-a71e-d24b671f55c1","created_at":"2020-07-24T18:57:33.334Z","updated_at":"2020-07-24T18:57:33.334Z","is_active":true,"name":{"ru":"200"},"description":null,"ticket_type_uuid":"dd58327a-ebab-4525-a2ad-bf000f976738","event_uuid":"d3d14343-8957-403a-9032-06e576788247","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","is_base_category":true,"parent_category_uuid":null}},"RefundRules":[{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2747","created_at":"2020-07-25T11:33:15.000Z","updated_at":"2020-07-25T11:33:30.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"interval":{"years":0,"months":0,"days":0,"hours":2,"minutes":1,"seconds":0,"milliseconds":0},"time_field":"begin_time"},"weight":1,"name":"Планетарий"}],"ExtOrder":{"uuid":"c5d3b19c-000b-4359-bd3d-a17453e17a14","created_at":"2020-10-12T08:11:52.547Z","updated_at":"2020-10-12T08:12:39.660Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"19595728","has_payments":false,"has_refunds":false,"has_reserves":true,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","meta":{"status":"complete","order_uuid":"a2cb3c04-0c62-11eb-9565-4237f251a997","payment_sum":20000,"payment_uuid":"b1cfe808-0c62-11eb-9565-4237f251a997","reservation_exp":"2020-10-12 11:27:14+03","ext_schedule_uuid":"69e7dd62-f3f1-4eeb-a417-6a5e094ead24"},"ttl":"2020-10-12T08:26:52.546Z","ExtSource":{"uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","created_at":"2020-06-26T11:10:23.000Z","updated_at":"2020-10-12T07:50:29.161Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":"UTX PLANET PROD","connection":{"config":{"alias":"lastick_gate_planet","api_keys":{"info":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq","sale":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq"}},"endpoint":"http://ak.xd.zapomni.systems","_endpoint":"http://91.229.221.101"},"params":{"import_settings":{"step_days":1,"look_ahead_days":13},"order_item_settings":{"group_ext_orders_by":"schedule"},"can_refund_positions":true},"match_settings":{"hall":"auto","spot":"auto","event":"auto","tickets":"priority"},"protocol_class":"Unitix_v1","content_provider_class":null,"alias":"utx_planet_prod","last_updated_at":"2020-10-12T07:49:30.133Z","principal":{"name":"Акционерное общество «Планетарий»","taxpayer_number":"7709679191"},"ext_principal_uuid":null,"principal_uuid":null}}},"meta":{"operations":{"refund":{"allow":false,"value":[]}}},"eticket":"/tickets/78/5d/ce3187dd-edc1-4ba0-8e52-b3d2063ad587/43002078"}]},"meta":{"operations":{"refund":{"allow":true}}}},{"data":{"uuid":"95857f7e-7a8b-4fbc-b6cc-83be704ab0c8","created_at":"2020-10-12T08:11:52.795Z","updated_at":"2020-10-12T08:12:39.688Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"19596228","has_payments":false,"has_refunds":false,"has_reserves":true,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","meta":{"status":"complete","order_uuid":"a2de2cd8-0c62-11eb-9565-4237f251a997","payment_sum":110000,"payment_uuid":"b1e5f5da-0c62-11eb-9565-4237f251a997","reservation_exp":"2020-10-12 11:27:14+03","ext_schedule_uuid":"489c8b0d-c90b-46f3-83a8-e2aa60c29823"},"ttl":"2020-10-12T08:26:52.794Z","OrderItemsContainer":[{"data":{"uuid":"338412cb-86c5-4f6b-9951-3af0e65cb03f","created_at":"2020-10-12T08:11:52.774Z","updated_at":"2020-10-16T15:24:17.622Z","is_active":true,"deleted_at":null,"is_deleted":false,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","cart_item_uuid":null,"number":"43003060","meta":{"item_id":10882,"place_id":"21","price_id":"0","ticket_id":44713,"position_id":42848,"ticket_number":"128334863"},"product_item_uuid":"f4709e4e-ebf2-4ed3-b18a-0e9a4f6d47af","price_value_uuid":"b3ac4d82-89ec-4606-837c-4e9e0e19bfc3","currency":"rur","nominal_price":"55000","price_modifiers":[],"price_formula":null,"price":"55000","service_fee":"0","total_sum":"55000","refund_fee":"0","barcode":{"value":"00004096890409653518","format":"qrcode"},"status":"refund","status_ttl":null,"ext_price_value_uuid":"cff4d67a-2b70-4287-a941-14a5dbbcbc01","ext_nominal_price":"55000","ext_order_uuid":"95857f7e-7a8b-4fbc-b6cc-83be704ab0c8","last_error":null,"applied_promocodes":[],"applied_promos":[],"ProductItem":{"product_item_type":"ticket","uuid":"f4709e4e-ebf2-4ed3-b18a-0e9a4f6d47af","created_at":"2020-10-12T07:56:02.820Z","updated_at":"2020-10-12T07:56:02.820Z","is_active":true,"deleted_at":null,"is_deleted":false,"source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","product_desc_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","supplier_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","quantity":1,"price_category_uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","ext_hall_uuid":"db335be7-1945-47c0-9c00-cf7538d98046","ext_spot_uuid":"d6fce4dd-39a1-4e99-ac21-aeb53b986ff6","ext_schedule_uuid":"489c8b0d-c90b-46f3-83a8-e2aa60c29823","ext_price_values":["cff4d67a-2b70-4287-a941-14a5dbbcbc01"],"ext_place_uuid":"7c4b5d08-c2bf-4522-ad91-98a981c8d6ea","place_uuid":"ad6ab1bc-2919-414e-886d-b0bbe5fc6392","schedule_uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","meta":{"ext_row_num":"5","ext_place_id":21,"ext_seat_num":"5","ext_sector_id":1,"ext_fragment_id":0},"is_for_sale":true,"is_for_booking":false,"group_sale":false,"ProductDesc":{"product_type":"event","uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","created_at":"2018-12-14T14:08:51.408Z","updated_at":"2019-03-20T06:31:46.256Z","is_active":true,"deleted_at":null,"is_deleted":false,"product_category_uuid":null,"tags":null,"name":{"en":null,"ru":"Полет над Москвой"},"appname":{},"short_name":{"en":null,"ru":"Полет над Москвой"},"description":{},"short_description":{},"extended_props":{},"poster":null,"posters":null,"media":null,"rating":null,"pg_rating":"6+","tabs":null,"do_not_update_from_ext":true,"content_loaded_at":null,"content_approved_at":null,"duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":20,"seconds":0,"milliseconds":0},"is_season":false,"season_label":null,"season_number":null},"Schedule":{"uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","created_at":"2020-10-12T07:51:46.317Z","updated_at":"2020-10-12T07:51:46.327Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","event_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","has_geometry":true,"is_for_sale":true,"season_event_uuid":null,"is_season_head":false,"is_season_part":false,"season_schedules":null,"begin_time":"2020-10-24T11:30:00.000Z","end_time":"2020-10-24T11:50:00.000Z","duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":20,"seconds":0,"milliseconds":0},"begin":"2020-10-24 14:30:00","end":"2020-10-24 14:50:00","hall_geometry_uuid":"c2c425d6-b0d2-4a60-a535-6142f74c9ead","tags":["92ea376d-8c39-4057-9065-c48663af91fe","9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","db992968-4508-4ca0-8149-89740c18f427"],"price_modifier_uuid":null,"organizer_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","is_sold_out":false,"LinkedSchedules":[]},"HallPlace":{"uuid":"ad6ab1bc-2919-414e-886d-b0bbe5fc6392","created_at":"2020-07-24T18:54:09.506Z","updated_at":"2020-07-24T18:54:09.506Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_geometry_uuid":"c2c425d6-b0d2-4a60-a535-6142f74c9ead","hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","sector_uuid":null,"fragment_uuid":"709852fb-a757-4573-ba19-071af7863662","row_uuid":"bb5fdc8a-d2d4-4b29-a834-5461554a9fe7","name":"5","geometry":{"h":358.97435897435935,"w":358.97435897435935,"cx":2820.5128205128226,"cy":974.358974358975},"symbol_uuid":null,"meta":{"row":{"name":"5","uuid":"bb5fdc8a-d2d4-4b29-a834-5461554a9fe7","prefix":null},"seat":"5","group":null,"sector":null,"fragment":{"name":{"ru":null},"uuid":"709852fb-a757-4573-ba19-071af7863662"},"group_size":null}},"Hall":{"uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","created_at":"2018-12-07T09:45:02.190Z","updated_at":"2019-02-27T10:56:45.037Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"en":"4D cinema","ru":"4D кинотеатр"},"short_name":{"ru":"4D кинотеатр"},"description":null,"address":{"ru":null},"location":null,"poster":null,"media_info":[{"name":"4дкинотеатр.jpg","path":"/e9/c1/03d370c4-db41-41e0-b469-5240164f1c9e/4дкинотеатр.jpg","size":32484,"type":"image/jpeg","color":[21,14,16],"width":662,"height":327,"palette":[[28,19,21],[106,83,78],[50,43,88],[76,86,73]],"uploaded_at":1544186042038}],"contacts":null,"work_hours":null,"website":null,"spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","tags":["db992968-4508-4ca0-8149-89740c18f427"],"tabs":null},"Spot":{"uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","created_at":"2018-12-07T09:45:02.123Z","updated_at":"2020-10-14T13:34:53.692Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"ru":"Планетарий"},"short_name":{"ru":"Планетарий"},"description":null,"address":{"ru":"укукуккуцукуук"},"location":null,"poster":null,"media_info":[{"name":"pony.png","path":"/27/60/2e8797e6-39c2-48b5-857a-ef4331060672/pony.png","size":700433,"type":"image/png","color":[4,4,4],"width":1920,"height":1200,"palette":[[5,4,5],[227,175,161],[108,69,140],[14,173,115]],"uploaded_at":1560160798607}],"contacts":null,"work_hours":{"date":{},"day_of_week":{"0":{"n":0,"end_time":"14:00","start_time":"10:00"},"1":{"n":1,"end_time":"18:00","start_time":"10:00"},"2":{"n":2,"end_time":"18:00","start_time":"10:00"},"3":{"n":3,"end_time":"18:00","start_time":"10:00"},"4":{"n":4,"end_time":"16:00","start_time":"10:00"},"5":{"n":5,"end_time":"18:00","start_time":"10:00"},"6":{"n":6,"end_time":"15:00","start_time":"10:00"}},"day_of_year":{}},"website":null,"tags":["9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","92ea376d-8c39-4057-9065-c48663af91fe"],"tabs":null,"city_uuid":"1de91a10-069b-441e-91ca-3aeefcbfd0a1"},"SeasonEvent":null},"PriceValue":{"uuid":"b3ac4d82-89ec-4606-837c-4e9e0e19bfc3","created_at":"2020-10-12T07:56:02.665Z","updated_at":"2020-10-12T07:56:02.665Z","is_active":true,"is_base_price":true,"price_category_uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","schedule_uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","amount":55000,"amount_currency":"rur","base_group_price":null,"PriceCategory":{"uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","created_at":"2020-07-24T18:57:40.042Z","updated_at":"2020-07-24T18:57:40.042Z","is_active":true,"name":{"ru":"450"},"description":null,"ticket_type_uuid":"dd58327a-ebab-4525-a2ad-bf000f976738","event_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","is_base_category":true,"parent_category_uuid":null}},"RefundRules":[{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2747","created_at":"2020-07-25T11:33:15.000Z","updated_at":"2020-07-25T11:33:30.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"interval":{"years":0,"months":0,"days":0,"hours":2,"minutes":1,"seconds":0,"milliseconds":0},"time_field":"begin_time"},"weight":1,"name":"Планетарий"}],"ExtOrder":{"uuid":"95857f7e-7a8b-4fbc-b6cc-83be704ab0c8","created_at":"2020-10-12T08:11:52.795Z","updated_at":"2020-10-12T08:12:39.688Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"19596228","has_payments":false,"has_refunds":false,"has_reserves":true,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","meta":{"status":"complete","order_uuid":"a2de2cd8-0c62-11eb-9565-4237f251a997","payment_sum":110000,"payment_uuid":"b1e5f5da-0c62-11eb-9565-4237f251a997","reservation_exp":"2020-10-12 11:27:14+03","ext_schedule_uuid":"489c8b0d-c90b-46f3-83a8-e2aa60c29823"},"ttl":"2020-10-12T08:26:52.794Z","ExtSource":{"uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","created_at":"2020-06-26T11:10:23.000Z","updated_at":"2020-10-12T07:50:29.161Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":"UTX PLANET PROD","connection":{"config":{"alias":"lastick_gate_planet","api_keys":{"info":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq","sale":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq"}},"endpoint":"http://ak.xd.zapomni.systems","_endpoint":"http://91.229.221.101"},"params":{"import_settings":{"step_days":1,"look_ahead_days":13},"order_item_settings":{"group_ext_orders_by":"schedule"},"can_refund_positions":true},"match_settings":{"hall":"auto","spot":"auto","event":"auto","tickets":"priority"},"protocol_class":"Unitix_v1","content_provider_class":null,"alias":"utx_planet_prod","last_updated_at":"2020-10-12T07:49:30.133Z","principal":{"name":"Акционерное общество «Планетарий»","taxpayer_number":"7709679191"},"ext_principal_uuid":null,"principal_uuid":null}}},"meta":{"operations":{"refund":{"allow":false,"value":[]}}},"eticket":"/tickets/78/5d/ce3187dd-edc1-4ba0-8e52-b3d2063ad587/43003060"},{"data":{"uuid":"1237ff6b-df6b-4fc5-87e4-af34b1cdcc61","created_at":"2020-10-12T08:11:56.237Z","updated_at":"2020-10-16T15:40:24.133Z","is_active":true,"deleted_at":null,"is_deleted":false,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","cart_item_uuid":null,"number":"43004014","meta":{"item_id":10882,"place_id":"9","price_id":"0","ticket_id":44714,"position_id":42849,"ticket_number":"128335076"},"product_item_uuid":"db9526f7-5473-400a-99c6-a8d6769cc5ad","price_value_uuid":"b3ac4d82-89ec-4606-837c-4e9e0e19bfc3","currency":"rur","nominal_price":"55000","price_modifiers":[],"price_formula":null,"price":"55000","service_fee":"0","total_sum":"55000","refund_fee":"0","barcode":{"value":"00004096310409663073","format":"qrcode"},"status":"sold","status_ttl":"2020-10-12T08:26:56.000Z","ext_price_value_uuid":"cff4d67a-2b70-4287-a941-14a5dbbcbc01","ext_nominal_price":"55000","ext_order_uuid":"95857f7e-7a8b-4fbc-b6cc-83be704ab0c8","last_error":{},"applied_promocodes":[],"applied_promos":[],"ProductItem":{"product_item_type":"ticket","uuid":"db9526f7-5473-400a-99c6-a8d6769cc5ad","created_at":"2020-10-12T07:56:02.780Z","updated_at":"2020-10-12T07:56:02.780Z","is_active":true,"deleted_at":null,"is_deleted":false,"source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","product_desc_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","supplier_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","quantity":1,"price_category_uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","ext_hall_uuid":"db335be7-1945-47c0-9c00-cf7538d98046","ext_spot_uuid":"d6fce4dd-39a1-4e99-ac21-aeb53b986ff6","ext_schedule_uuid":"489c8b0d-c90b-46f3-83a8-e2aa60c29823","ext_price_values":["cff4d67a-2b70-4287-a941-14a5dbbcbc01"],"ext_place_uuid":"fb3171a0-691a-45fc-a8ca-053b0f83881f","place_uuid":"ff09a8f1-1179-4159-b428-9d41e9ba1a52","schedule_uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","meta":{"ext_row_num":"4","ext_place_id":9,"ext_seat_num":"8","ext_sector_id":1,"ext_fragment_id":0},"is_for_sale":true,"is_for_booking":false,"group_sale":false,"ProductDesc":{"product_type":"event","uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","created_at":"2018-12-14T14:08:51.408Z","updated_at":"2019-03-20T06:31:46.256Z","is_active":true,"deleted_at":null,"is_deleted":false,"product_category_uuid":null,"tags":null,"name":{"en":null,"ru":"Полет над Москвой"},"appname":{},"short_name":{"en":null,"ru":"Полет над Москвой"},"description":{},"short_description":{},"extended_props":{},"poster":null,"posters":null,"media":null,"rating":null,"pg_rating":"6+","tabs":null,"do_not_update_from_ext":true,"content_loaded_at":null,"content_approved_at":null,"duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":20,"seconds":0,"milliseconds":0},"is_season":false,"season_label":null,"season_number":null},"Schedule":{"uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","created_at":"2020-10-12T07:51:46.317Z","updated_at":"2020-10-12T07:51:46.327Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","event_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","has_geometry":true,"is_for_sale":true,"season_event_uuid":null,"is_season_head":false,"is_season_part":false,"season_schedules":null,"begin_time":"2020-10-24T11:30:00.000Z","end_time":"2020-10-24T11:50:00.000Z","duration":{"years":0,"months":0,"days":0,"hours":0,"minutes":20,"seconds":0,"milliseconds":0},"begin":"2020-10-24 14:30:00","end":"2020-10-24 14:50:00","hall_geometry_uuid":"c2c425d6-b0d2-4a60-a535-6142f74c9ead","tags":["92ea376d-8c39-4057-9065-c48663af91fe","9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","db992968-4508-4ca0-8149-89740c18f427"],"price_modifier_uuid":null,"organizer_legal_uuid":"b7e6c03e-4aa5-4f72-a301-0196bb55faaf","is_sold_out":false,"LinkedSchedules":[]},"HallPlace":{"uuid":"ff09a8f1-1179-4159-b428-9d41e9ba1a52","created_at":"2020-07-24T18:54:09.298Z","updated_at":"2020-07-24T18:54:09.298Z","is_active":true,"deleted_at":null,"is_deleted":false,"hall_geometry_uuid":"c2c425d6-b0d2-4a60-a535-6142f74c9ead","hall_uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","sector_uuid":null,"fragment_uuid":"709852fb-a757-4573-ba19-071af7863662","row_uuid":"bf14d20e-a29f-4a25-81c1-036c2a33c973","name":"8","geometry":{"h":358.97435897435935,"w":358.97435897435935,"cx":3230.769230769236,"cy":1589.7435897435907},"symbol_uuid":null,"meta":{"row":{"name":"4","uuid":"bf14d20e-a29f-4a25-81c1-036c2a33c973","prefix":null},"seat":"8","group":null,"sector":null,"fragment":{"name":{"ru":null},"uuid":"709852fb-a757-4573-ba19-071af7863662"},"group_size":null}},"Hall":{"uuid":"03d370c4-db41-41e0-b469-5240164f1c9e","created_at":"2018-12-07T09:45:02.190Z","updated_at":"2019-02-27T10:56:45.037Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"en":"4D cinema","ru":"4D кинотеатр"},"short_name":{"ru":"4D кинотеатр"},"description":null,"address":{"ru":null},"location":null,"poster":null,"media_info":[{"name":"4дкинотеатр.jpg","path":"/e9/c1/03d370c4-db41-41e0-b469-5240164f1c9e/4дкинотеатр.jpg","size":32484,"type":"image/jpeg","color":[21,14,16],"width":662,"height":327,"palette":[[28,19,21],[106,83,78],[50,43,88],[76,86,73]],"uploaded_at":1544186042038}],"contacts":null,"work_hours":null,"website":null,"spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","tags":["db992968-4508-4ca0-8149-89740c18f427"],"tabs":null},"Spot":{"uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","created_at":"2018-12-07T09:45:02.123Z","updated_at":"2020-10-14T13:34:53.692Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":{"ru":"Планетарий"},"short_name":{"ru":"Планетарий"},"description":null,"address":{"ru":"укукуккуцукуук"},"location":null,"poster":null,"media_info":[{"name":"pony.png","path":"/27/60/2e8797e6-39c2-48b5-857a-ef4331060672/pony.png","size":700433,"type":"image/png","color":[4,4,4],"width":1920,"height":1200,"palette":[[5,4,5],[227,175,161],[108,69,140],[14,173,115]],"uploaded_at":1560160798607}],"contacts":null,"work_hours":{"date":{},"day_of_week":{"0":{"n":0,"end_time":"14:00","start_time":"10:00"},"1":{"n":1,"end_time":"18:00","start_time":"10:00"},"2":{"n":2,"end_time":"18:00","start_time":"10:00"},"3":{"n":3,"end_time":"18:00","start_time":"10:00"},"4":{"n":4,"end_time":"16:00","start_time":"10:00"},"5":{"n":5,"end_time":"18:00","start_time":"10:00"},"6":{"n":6,"end_time":"15:00","start_time":"10:00"}},"day_of_year":{}},"website":null,"tags":["9ec41faa-96ed-4317-911d-ea43d3d6c6ac","102cae60-96c2-4061-811f-2504cef7e5a3","92ea376d-8c39-4057-9065-c48663af91fe"],"tabs":null,"city_uuid":"1de91a10-069b-441e-91ca-3aeefcbfd0a1"},"SeasonEvent":null},"PriceValue":{"uuid":"b3ac4d82-89ec-4606-837c-4e9e0e19bfc3","created_at":"2020-10-12T07:56:02.665Z","updated_at":"2020-10-12T07:56:02.665Z","is_active":true,"is_base_price":true,"price_category_uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","schedule_uuid":"ed4bd4ed-d5c9-4689-ba96-28915cdfc2cd","amount":55000,"amount_currency":"rur","base_group_price":null,"PriceCategory":{"uuid":"2f15f3f1-d69e-4d29-bd1e-4d8e036fcd45","created_at":"2020-07-24T18:57:40.042Z","updated_at":"2020-07-24T18:57:40.042Z","is_active":true,"name":{"ru":"450"},"description":null,"ticket_type_uuid":"dd58327a-ebab-4525-a2ad-bf000f976738","event_uuid":"3069e98f-ff2d-4dcd-9859-4f1146209be5","spot_uuid":"2e8797e6-39c2-48b5-857a-ef4331060672","is_base_category":true,"parent_category_uuid":null}},"RefundRules":[{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2747","created_at":"2020-07-25T11:33:15.000Z","updated_at":"2020-07-25T11:33:30.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"interval":{"years":0,"months":0,"days":0,"hours":2,"minutes":1,"seconds":0,"milliseconds":0},"time_field":"begin_time"},"weight":1,"name":"Планетарий"}],"ExtOrder":{"uuid":"95857f7e-7a8b-4fbc-b6cc-83be704ab0c8","created_at":"2020-10-12T08:11:52.795Z","updated_at":"2020-10-12T08:12:39.688Z","is_active":true,"deleted_at":null,"is_deleted":false,"number":"19596228","has_payments":false,"has_refunds":false,"has_reserves":true,"order_uuid":"ce3187dd-edc1-4ba0-8e52-b3d2063ad587","source_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","meta":{"status":"complete","order_uuid":"a2de2cd8-0c62-11eb-9565-4237f251a997","payment_sum":110000,"payment_uuid":"b1e5f5da-0c62-11eb-9565-4237f251a997","reservation_exp":"2020-10-12 11:27:14+03","ext_schedule_uuid":"489c8b0d-c90b-46f3-83a8-e2aa60c29823"},"ttl":"2020-10-12T08:26:52.794Z","ExtSource":{"uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","created_at":"2020-06-26T11:10:23.000Z","updated_at":"2020-10-12T07:50:29.161Z","is_active":true,"deleted_at":null,"is_deleted":false,"name":"UTX PLANET PROD","connection":{"config":{"alias":"lastick_gate_planet","api_keys":{"info":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq","sale":"ZvNxYLYAPZOAkapEixUzZG5eLthXtbCq"}},"endpoint":"http://ak.xd.zapomni.systems","_endpoint":"http://91.229.221.101"},"params":{"import_settings":{"step_days":1,"look_ahead_days":13},"order_item_settings":{"group_ext_orders_by":"schedule"},"can_refund_positions":true},"match_settings":{"hall":"auto","spot":"auto","event":"auto","tickets":"priority"},"protocol_class":"Unitix_v1","content_provider_class":null,"alias":"utx_planet_prod","last_updated_at":"2020-10-12T07:49:30.133Z","principal":{"name":"Акционерное общество «Планетарий»","taxpayer_number":"7709679191"},"ext_principal_uuid":null,"principal_uuid":null}}},"meta":{"operations":{"refund":{"allow":true,"value":[{"rule":"refund_date","value":"2020-10-24T13:31:00.000Z","allow":true}]}}},"eticket":"/tickets/78/5d/ce3187dd-edc1-4ba0-8e52-b3d2063ad587/43004014","refund_fee":0,"refund_rules":[{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2746","created_at":"2020-07-25T11:33:13.000Z","updated_at":"2020-07-25T11:33:28.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":-5},"value_type":"factor"}},"weight":1,"name":"Standart FEE -5 days 50"},{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2745","created_at":"2020-07-25T11:33:11.000Z","updated_at":"2020-07-25T11:33:25.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":-1},"value_type":"factor"}},"weight":1,"name":"Standart FEE -3 days 70"},{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2744","created_at":"2020-07-25T11:33:09.000Z","updated_at":"2020-07-25T11:33:23.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":0},"value_type":"factor"}},"weight":1,"name":"Standart FEE 0 days 100"}]}]},"meta":{"operations":{"refund":{"allow":true}},"refund_rules":[{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2746","created_at":"2020-07-25T11:33:13.000Z","updated_at":"2020-07-25T11:33:28.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":-5},"value_type":"factor"}},"weight":1,"name":"Standart FEE -5 days 50"},{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2745","created_at":"2020-07-25T11:33:11.000Z","updated_at":"2020-07-25T11:33:25.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":-1},"value_type":"factor"}},"weight":1,"name":"Standart FEE -3 days 70"},{"uuid":"51a485fc-3aa1-4736-b216-ce3a8f2d2744","created_at":"2020-07-25T11:33:09.000Z","updated_at":"2020-07-25T11:33:23.000Z","is_active":true,"entity_uuid":"8bc8d574-c54b-4ae7-b0c4-a14085a4027b","entity_type":"source","can_be_refund":true,"rule":{"value":{"value":0,"interval":{"days":0},"value_type":"factor"}},"weight":1,"name":"Standart FEE 0 days 100"}]}}],"OrderPaymentsContainer":[{"uuid":"1aa72af9-474a-4644-a3e9-f56d79236942","created_at":"2020-10-16T15:38:00.768Z","updated_at":"2020-10-16T15:38:04.480Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"outgoing","amount":55000,"currency":"rur","status":"error","error":"PAYMENT SERVICE ERROR (Error: {\"error\":\"REFUND_FAILED\"})","parent_order_payment_uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}},{"uuid":"1a8cdf2c-7d30-4379-aeff-bdeeaa030d03","created_at":"2020-10-16T15:38:00.045Z","updated_at":"2020-10-16T15:38:04.033Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"outgoing","amount":55000,"currency":"rur","status":"complete","error":null,"parent_order_payment_uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}},{"uuid":"c93e2d66-5be7-4e44-adcb-07e3f29f16d2","created_at":"2020-10-16T15:37:59.738Z","updated_at":"2020-10-16T15:38:05.691Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"outgoing","amount":55000,"currency":"rur","status":"error","error":"PAYMENT SERVICE ERROR (Error: {\"error\":\"REFUND_FAILED\"})","parent_order_payment_uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}},{"uuid":"79ce317f-1859-447e-a934-1e860cac0af8","created_at":"2020-10-16T15:24:17.646Z","updated_at":"2020-10-16T15:24:19.710Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"outgoing","amount":55000,"currency":"rur","status":"complete","error":null,"parent_order_payment_uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}},{"uuid":"7dd92172-e678-45f6-a2e9-4e90d431df78","created_at":"2020-10-16T15:12:19.691Z","updated_at":"2020-10-16T15:12:21.977Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"outgoing","amount":20000,"currency":"rur","status":"complete","error":null,"parent_order_payment_uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}},{"uuid":"70365cf3-07a4-491c-8a91-f777bd83b4a2","created_at":"2020-10-12T08:12:14.588Z","updated_at":"2020-10-12T08:12:41.057Z","is_active":true,"payment_method_uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","type":"incoming","amount":130000,"currency":"rur","status":"complete","error":null,"parent_order_payment_uuid":null,"PaymentMethod":{"uuid":"76f7dd45-62fa-444c-a5a3-a6780413ec7c","name":{"en":"GooglePay","ru":"GooglePay"},"alias":"demo_googlepay","type":"gpay"}}]},"meta":{"operations":{"refund":{"allow":true},"resend_notifications":{"allow":true},"resend_email":{"allow":true},"resend_sms":{"allow":false}}}}];
  public fetching = false;

  constructor(
    private ordersService: OrdersService
  ) {
  }

  ngOnInit(): void {
    this.ordersService.removeOrderItem$.subscribe(item => {
      this.ordersService.getOrders().subscribe(orders => {
        this.orders = orders;
      });
    });
  }

  ngAfterContentChecked(): void {
    console.log('OrderRequestComponent ngAfterContentChecked');
  }

  saveToken(token: string): void {
    localStorage.setItem('x-auth-token', token);
    // localStorage.setItem('x-auth-token-dt', `${Date.now()}`);
  }

  removeToken(): void {
    localStorage.removeItem('x-auth-token');
    // localStorage.removeItem('x-auth-token-dt');
  }

  onLogin(req$: Observable<HttpResponse<any>>): void {
    this.removeToken();
    req$.subscribe(res => {
      console.log('login', res);
      this.saveToken(res.headers.get('x-auth-token'));
    });
  }

  onLoginCode(req$: Observable<HttpResponse<any>>): void {
    this.fetching = true;

    req$.pipe(
      switchMap(
        res => {
          this.saveToken(res.headers.get('x-auth-token'));
          return this.ordersService.getOrders();
        }
      ),
      catchError(
        (err) => {
          this.orders = null;
          this.ordersError = true;
          return throwError(err);
        }
      ),
      finalize(
        () => {
          setTimeout(() => {
            this.fetching = false;
          }, 50);
        }
      )
    ).subscribe(data => {
      console.log('orders', data);
      this.orders = data;
      this.ordersError = !data?.length;
    });
  }
}
